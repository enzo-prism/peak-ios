name: CI

on:
  push:
    branches: [main]
  pull_request:

jobs:
  tests:
    runs-on: macos-14
    steps:
      - uses: actions/checkout@v4
      - uses: maxim-lobanov/setup-xcode@v1
        with:
          xcode-version: latest-stable
      - name: Choose latest iPhone simulator
        run: |
          python3 - <<'PY'
          import json, re, subprocess
          data = json.loads(subprocess.check_output(["xcrun", "simctl", "list", "devices", "available", "-j"]))
          iphones = {}
          for runtime, devices in data["devices"].items():
            if "iOS" not in runtime:
              continue
            for d in devices:
              name = d.get("name", "")
              if name.startswith("iPhone ") and d.get("isAvailable", True):
                iphones[name] = d.get("udid")
          def key(name):
            m = re.search(r"iPhone (\\d+)", name)
            return int(m.group(1)) if m else 0
          best = sorted(iphones.keys(), key=key, reverse=True)[0]
          udid = iphones[best]
          print(best)
          with open("dest.txt", "w") as f:
            f.write(f"platform=iOS Simulator,id={udid}")
          PY
          echo "DESTINATION=$(cat dest.txt)" >> $GITHUB_ENV
      - name: Run unit tests
        run: >-
          xcodebuild -project Peak.xcodeproj -scheme Peak
          -destination "$DESTINATION"
          -only-testing:PeakTests test
      - name: Run UI tests
        run: >-
          xcodebuild -project Peak.xcodeproj -scheme Peak
          -destination "$DESTINATION"
          -only-testing:PeakUITests test
